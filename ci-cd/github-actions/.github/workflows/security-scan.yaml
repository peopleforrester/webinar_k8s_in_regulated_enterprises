# GitHub Actions Security Scan Workflow Template
name: Security Scan

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1" # Weekly Monday 6AM UTC

jobs:
  trivy-image-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  trivy-config-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "."
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH,MEDIUM"

  kubescape-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Kubescape
        run: curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash

      - name: Run NSA framework scan
        run: |
          kubescape scan framework nsa workloads/ \
            --format junit --output kubescape-nsa.xml || true

      - name: Upload Kubescape results
        uses: actions/upload-artifact@v4
        with:
          name: kubescape-results
          path: kubescape-nsa.xml

  kyverno-policy-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Kyverno CLI
        run: |
          curl -sLO https://github.com/kyverno/kyverno/releases/latest/download/kyverno-cli_linux_amd64.tar.gz
          tar -xzf kyverno-cli_linux_amd64.tar.gz
          chmod +x kyverno
          sudo mv kyverno /usr/local/bin/

      - name: Validate compliant app against policies
        run: |
          kyverno apply tools/kyverno/policies/ \
            --resource workloads/compliant-app/deployment.yaml

      - name: Verify vulnerable app fails policies
        run: |
          if kyverno apply tools/kyverno/policies/ \
            --resource workloads/vulnerable-app/deployment.yaml 2>/dev/null; then
            echo "ERROR: Vulnerable app should have failed policy check!"
            exit 1
          else
            echo "Vulnerable app correctly rejected by policies"
          fi
