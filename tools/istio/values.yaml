# ABOUTME: Helm values for istio/istiod chart configuring the Istio control plane.
# ABOUTME: Enables STRICT mTLS, access logging, tracing, and sidecar resource defaults.
# =============================================================================
# ISTIO HELM CHART VALUES (istiod)
# =============================================================================
# Tool:    Istio - Service Mesh
# Chart:   istio/istiod (install istio/base first for CRDs)
# Repo:    https://github.com/istio/istio
# Docs:    https://istio.io/latest/docs/
#
# INSTALL ORDER:
#   1. helm install istio-base istio/base -n istio-system --create-namespace
#   2. helm install istiod istio/istiod -n istio-system -f values.yaml
#
# PURPOSE:
# Istio is a CNCF Graduated service mesh that provides mutual TLS, traffic
# management, observability, and authorization between Kubernetes services.
# Envoy sidecar proxies intercept all pod traffic transparently.
#
# WHY ISTIO FOR REGULATED INDUSTRIES?
# 1. mTLS encrypts ALL service-to-service traffic (PCI-DSS 4.1, DORA Art.9)
# 2. AuthorizationPolicy enforces least-privilege communication (SOC 2 CC6.1)
# 3. Access logs provide complete audit trail of every request
# 4. Automatic certificate rotation limits compromised cert blast radius
# 5. SPIFFE identity enables cryptographic service authentication
#
# ARCHITECTURE:
#
#   +---------------------------+
#   |        istiod             |
#   |  (Control Plane)         |
#   |  CA + Pilot + Config     |
#   +----------+----------------+
#              |
#    Pushes certs, routes, policies
#              |
#   +----------v----------------+
#   |  Envoy Sidecar Proxies    |
#   |  (Data Plane)            |
#   |  Per-pod traffic interception |
#   +---------------------------+
#
# =============================================================================

# -----------------------------------------------------------------------------
# PILOT (istiod) CONFIGURATION
# -----------------------------------------------------------------------------
# Pilot is the core component of istiod. It distributes configuration to
# Envoy sidecars, manages the service registry, and handles xDS (discovery
# service) protocol communication with all proxies in the mesh.
#
# REPLICAS:
# For production regulated environments, run at least 2 replicas with
# pod anti-affinity for high availability. A single replica is acceptable
# for demo and lab environments.
#
# RESOURCE SIZING:
# istiod resource consumption scales with the number of services and
# endpoints in the mesh. For clusters with:
#   <100 services:   500m CPU / 1Gi memory
#   100-500 services: 1 CPU / 2Gi memory
#   500+ services:    2 CPU / 4Gi memory
#
# REGULATORY CONTEXT (DORA Article 9):
# "ICT systems shall be resilient" -- multiple replicas ensure policy
# enforcement survives component failures.
# -----------------------------------------------------------------------------
pilot:
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi

  # ---------------------------------------------------------------------------
  # Autoscaling
  # ---------------------------------------------------------------------------
  # Enable HPA for production. The control plane must scale with mesh traffic.
  # Disabled for lab environments to conserve resources.
  # ---------------------------------------------------------------------------
  autoscaleEnabled: false
  autoscaleMin: 1
  autoscaleMax: 3

# -----------------------------------------------------------------------------
# GLOBAL MESH CONFIGURATION
# -----------------------------------------------------------------------------
# These settings apply to the entire mesh -- every sidecar and gateway proxy.
# Changes here propagate to all Envoy instances via xDS.
# -----------------------------------------------------------------------------
global:
  # ---------------------------------------------------------------------------
  # Proxy (Envoy Sidecar) Configuration
  # ---------------------------------------------------------------------------
  # Resource limits for every Envoy sidecar injected into application pods.
  # These are per-sidecar costs added to every meshed pod.
  #
  # CAPACITY PLANNING:
  # If you have 20 pods in the mesh, sidecar overhead is:
  #   Memory: 20 * 128Mi = 2.5Gi additional cluster memory
  #   CPU:    20 * 50m   = 1000m additional CPU requests
  #
  # For regulated environments, the overhead is justified by:
  #   - Encrypted traffic (PCI-DSS 4.1)
  #   - Per-request audit trail (SOC 2 CC7.2)
  #   - Service identity verification (NCUA least privilege)
  #
  # TUNING:
  # Monitor envoy_server_memory_allocated and envoy_server_total_connections.
  # Increase limits if sidecars are OOMKilled or throttled.
  # ---------------------------------------------------------------------------
  proxy:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # -------------------------------------------------------------------------
    # Access Logging
    # -------------------------------------------------------------------------
    # Enables Envoy access logs for every request passing through the mesh.
    #
    # WHY ENABLE ACCESS LOGGING?
    # Access logs capture: source, destination, HTTP method, path, response
    # code, latency, bytes transferred, and identity (SPIFFE ID).
    #
    # REGULATORY CONTEXT:
    #   - PCI-DSS 10.1: Implement audit trails for all access
    #   - SOC 2 CC7.2: Monitor system components for anomalies
    #   - DORA Art.10: Detect anomalous activities
    #   - NCUA Part 748: "Log and monitor all access to network resources"
    #
    # PRODUCTION CONSIDERATION:
    # Access logs generate high volume. Configure log rotation and ship to
    # a centralized logging system (ELK, Loki, Splunk) with retention
    # policies matching regulatory requirements (typically 1-7 years).
    # -------------------------------------------------------------------------
    accessLogFile: /dev/stdout

    # -------------------------------------------------------------------------
    # Access Log Format
    # -------------------------------------------------------------------------
    # JSON format is preferred for structured log ingestion by SIEM tools.
    # Default Envoy text format is human-readable but harder to parse.
    # -------------------------------------------------------------------------
    accessLogEncoding: JSON

  # ---------------------------------------------------------------------------
  # Tracing Configuration
  # ---------------------------------------------------------------------------
  # Distributed tracing tracks requests across multiple services, showing
  # the full request path through the mesh.
  #
  # WHY TRACING MATTERS FOR COMPLIANCE:
  # - Proves network segmentation is working (requests follow expected paths)
  # - Identifies unauthorized service communication attempts
  # - Supports incident investigation (trace a suspicious request end-to-end)
  #
  # SAMPLE RATE:
  #   100% (1.0) -- Capture every request. Use for lab/demo environments.
  #   1% (0.01)  -- Capture 1 in 100 requests. Use for production to
  #                  manage tracing overhead while maintaining visibility.
  #
  # PRODUCTION RECOMMENDATION:
  # Start at 1% and increase if you need more trace coverage for specific
  # services. Use per-service overrides for critical paths.
  # ---------------------------------------------------------------------------
  tracer:
    zipkin:
      address: ""

# -----------------------------------------------------------------------------
# MESH CONFIGURATION
# -----------------------------------------------------------------------------
# MeshConfig controls mesh-wide behavior. These settings are applied via
# the istiod ConfigMap and distributed to all proxies.
#
# Reference: https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/
# -----------------------------------------------------------------------------
meshConfig:
  # ---------------------------------------------------------------------------
  # Default mTLS Mode
  # ---------------------------------------------------------------------------
  # STRICT: All traffic must be mTLS. Plain text connections are rejected.
  # PERMISSIVE: Accept both mTLS and plain text. Use during migration only.
  #
  # WHY STRICT?
  # In regulated environments, PERMISSIVE mode is a compliance gap because
  # it allows unencrypted service communication. STRICT mode guarantees
  # that every byte between services is encrypted with mutual authentication.
  #
  # MIGRATION PATH:
  # 1. Start with PERMISSIVE to onboard services without breaking traffic
  # 2. Monitor for non-mTLS connections in access logs
  # 3. Switch to STRICT once all services have sidecars
  #
  # REGULATORY CONTEXT:
  #   - PCI-DSS 4.1: "Use strong cryptography for transmission of data"
  #   - DORA Art.9: "Implement encryption for data in transit"
  #   - FFIEC: "Encrypt all sensitive data traversing internal networks"
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # Access Log Configuration
  # ---------------------------------------------------------------------------
  # Enable access logging at the mesh level. This captures logs from every
  # Envoy sidecar and gateway in the mesh.
  # ---------------------------------------------------------------------------
  accessLogFile: /dev/stdout
  accessLogEncoding: JSON

  # ---------------------------------------------------------------------------
  # Enable Auto mTLS
  # ---------------------------------------------------------------------------
  # When enabled, Istio automatically detects whether a destination has a
  # sidecar and uses mTLS if it does. Combined with STRICT PeerAuthentication,
  # this ensures all meshed traffic is encrypted.
  # ---------------------------------------------------------------------------
  enableAutoMtls: true

  # ---------------------------------------------------------------------------
  # Default Tracing Configuration
  # ---------------------------------------------------------------------------
  # Sample 100% of requests for lab/demo environments.
  # Change to 1.0 (percent, i.e., 0.01 ratio) for production.
  # ---------------------------------------------------------------------------
  defaultConfig:
    tracing:
      sampling: 100.0

    # -------------------------------------------------------------------------
    # Hold Application Start Until Proxy Is Ready
    # -------------------------------------------------------------------------
    # Prevents the application container from starting before the Envoy
    # sidecar is ready to handle traffic. Without this, the first few
    # requests may bypass the mesh (no mTLS, no policy enforcement).
    #
    # REGULATORY CONTEXT:
    # Ensures there is no window where traffic flows without encryption,
    # even during pod startup.
    # -------------------------------------------------------------------------
    holdApplicationUntilProxyStarts: true

  # ---------------------------------------------------------------------------
  # Outbound Traffic Policy
  # ---------------------------------------------------------------------------
  # REGISTRY_ONLY: Only allow traffic to services registered in the mesh.
  # ALLOW_ANY: Allow traffic to any destination (less secure).
  #
  # REGISTRY_ONLY enforces explicit egress control. Services must use
  # ServiceEntry CRDs to communicate with external endpoints, creating
  # an audit trail of all external dependencies.
  #
  # REGULATORY CONTEXT:
  #   - PCI-DSS 1.2: "Restrict connections to untrusted networks"
  #   - NCUA: "Control and monitor outbound network connections"
  # ---------------------------------------------------------------------------
  outboundTrafficPolicy:
    mode: REGISTRY_ONLY
