# ABOUTME: ExternalSecret that syncs a database password from Azure Key Vault into a K8s Secret.
# ABOUTME: Demonstrates refresh interval, key mapping, and secret ownership for rotation workflows.
#
# =============================================================================
# EXTERNAL SECRET - DATABASE CREDENTIALS
# =============================================================================
# This ExternalSecret tells ESO to fetch a specific secret from Azure Key Vault
# and write it into a native Kubernetes Secret in the target namespace.
#
# LIFECYCLE:
# 1. You apply this ExternalSecret resource
# 2. ESO reads it and contacts the referenced SecretStore
# 3. ESO authenticates to Azure Key Vault via workload identity
# 4. ESO fetches the secret value(s) from Key Vault
# 5. ESO creates a Kubernetes Secret with the fetched data
# 6. ESO re-fetches every refreshInterval and updates the Secret if changed
#
# SECRET ROTATION FLOW:
# 1. Security team rotates the password in Azure Key Vault
# 2. On the next refresh interval, ESO detects the change
# 3. ESO updates the Kubernetes Secret with the new value
# 4. Application picks up the new value via:
#    a. Volume mount (kubelet syncs within ~1 minute)
#    b. Reloader sidecar (e.g., stakater/Reloader triggers pod restart)
#    c. Application watches the Secret and reloads (best for zero-downtime)
#
# REGULATORY CONTEXT:
#   - NCUA/FFIEC: Credential rotation without application downtime
#   - SOC 2 CC6.7: Automated secrets lifecycle management
#   - DORA Article 9: Data protection via encrypted vault storage
#   - PCI-DSS Req 3.4: Credentials encrypted at rest in Key Vault
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: demo
  labels:
    app.kubernetes.io/part-of: external-secrets
    app.kubernetes.io/component: database
    compliance.regulated/ncua: "credential-management"
    compliance.regulated/soc2: "CC6.7"
spec:
  # ---------------------------------------------------------------------------
  # REFRESH INTERVAL
  # ---------------------------------------------------------------------------
  # How often ESO polls Azure Key Vault for changes to this secret.
  #
  # GUIDELINES:
  #   5m   -- Frequently rotated secrets (short-lived tokens, session keys)
  #   1h   -- Standard credentials (database passwords, API keys)
  #   24h  -- Rarely changed secrets (TLS CA certs, static config)
  #
  # TRADE-OFFS:
  #   Shorter interval = faster rotation pickup, more Key Vault API calls
  #   Longer interval  = fewer API calls, longer window of stale secrets
  #
  # KEY VAULT API LIMITS:
  # Azure Key Vault allows up to 2000 transactions per 10 seconds per vault.
  # With 100 ExternalSecrets at 5m refresh, that's ~0.3 calls/sec -- well
  # within limits. Adjust if you have hundreds of ExternalSecrets.
  #
  # REGULATORY CONTEXT (NCUA/FFIEC):
  # "Credentials should be rotated regularly." The refresh interval determines
  # how quickly a rotation in Key Vault propagates to your workloads.
  # ---------------------------------------------------------------------------
  refreshInterval: 1h

  # ---------------------------------------------------------------------------
  # SECRET STORE REFERENCE
  # ---------------------------------------------------------------------------
  # Points to the ClusterSecretStore (or SecretStore) that defines the
  # provider connection and authentication method.
  #
  # kind: ClusterSecretStore -- cluster-scoped, any namespace can reference it
  # kind: SecretStore         -- namespace-scoped, must be in same namespace
  # ---------------------------------------------------------------------------
  secretStoreRef:
    name: azure-keyvault
    kind: ClusterSecretStore

  # ---------------------------------------------------------------------------
  # TARGET SECRET CONFIGURATION
  # ---------------------------------------------------------------------------
  # Controls the Kubernetes Secret that ESO creates and manages.
  # ---------------------------------------------------------------------------
  target:
    # -------------------------------------------------------------------------
    # TARGET SECRET NAME
    # -------------------------------------------------------------------------
    # The name of the Kubernetes Secret to create. If omitted, defaults to the
    # ExternalSecret name (database-credentials in this case).
    # -------------------------------------------------------------------------
    name: database-credentials

    # -------------------------------------------------------------------------
    # CREATION POLICY
    # -------------------------------------------------------------------------
    # Owner -- ESO creates the Secret and sets ownerReference back to this
    #          ExternalSecret. Deleting the ExternalSecret deletes the Secret.
    # Orphan -- ESO creates the Secret but does not set ownerReference.
    #           The Secret survives ExternalSecret deletion.
    # Merge -- ESO merges data into an existing Secret (useful for adding
    #          keys to a Secret managed by another controller).
    # -------------------------------------------------------------------------
    creationPolicy: Owner

    # -------------------------------------------------------------------------
    # DELETION POLICY
    # -------------------------------------------------------------------------
    # Retain -- Keep the Kubernetes Secret if the ExternalSecret is deleted.
    #           Useful for critical secrets that must survive operator changes.
    # Delete -- Remove the Kubernetes Secret when ExternalSecret is deleted.
    #           Default behavior when creationPolicy is Owner.
    #
    # REGULATORY CONTEXT (DORA Article 9):
    # Consider Retain for production databases to prevent accidental secret
    # deletion during operator upgrades or namespace cleanup.
    # -------------------------------------------------------------------------
    deletionPolicy: Retain

  # ---------------------------------------------------------------------------
  # DATA MAPPINGS
  # ---------------------------------------------------------------------------
  # Maps remote secret keys in Azure Key Vault to local keys in the
  # Kubernetes Secret. Each entry fetches one value from the provider.
  #
  # KEY VAULT SECRET NAMING:
  # Key Vault secret names support alphanumeric characters and dashes only.
  # Common convention: <app>-<env>-<purpose>
  #   e.g., demo-prod-db-password, demo-prod-db-username
  #
  # KUBERNETES SECRET KEY NAMING:
  # Use names that match what your application expects in its env vars
  # or volume mount paths. Typical patterns:
  #   DB_PASSWORD, DB_USERNAME (env var style)
  #   password, username (volume mount style)
  # ---------------------------------------------------------------------------
  data:
    # -------------------------------------------------------------------------
    # DATABASE PASSWORD
    # -------------------------------------------------------------------------
    # remoteRef.key -- The secret name in Azure Key Vault
    # secretKey     -- The key name in the resulting Kubernetes Secret
    #
    # In Key Vault:  secret named "demo-db-password" with value "s3cur3P@ss"
    # In K8s Secret: data.DB_PASSWORD = "s3cur3P@ss" (base64 encoded)
    # -------------------------------------------------------------------------
    - secretKey: DB_PASSWORD
      remoteRef:
        key: demo-db-password

    # -------------------------------------------------------------------------
    # DATABASE USERNAME
    # -------------------------------------------------------------------------
    # Usernames are less sensitive but still belong in a Secret rather than
    # a ConfigMap, because they are part of the credential pair.
    # -------------------------------------------------------------------------
    - secretKey: DB_USERNAME
      remoteRef:
        key: demo-db-username

    # -------------------------------------------------------------------------
    # DATABASE CONNECTION STRING
    # -------------------------------------------------------------------------
    # For applications that expect a full connection string rather than
    # individual components. Stored as a single Key Vault secret.
    #
    # PROPERTY EXTRACTION (optional, not shown here):
    # If your Key Vault secret is JSON, you can extract specific fields:
    #   remoteRef:
    #     key: demo-db-config
    #     property: connectionString
    # This fetches the "connectionString" field from the JSON value.
    # -------------------------------------------------------------------------
    - secretKey: DB_CONNECTION_STRING
      remoteRef:
        key: demo-db-connection-string
