# ABOUTME: ClusterSecretStore connecting External Secrets Operator to Azure Key Vault.
# ABOUTME: Uses AKS workload identity (federated OIDC) for credential-free authentication.
#
# =============================================================================
# CLUSTER SECRET STORE - AZURE KEY VAULT
# =============================================================================
# This ClusterSecretStore configures External Secrets Operator (ESO) to
# authenticate to Azure Key Vault using AKS workload identity.
#
# SCOPE:
# ClusterSecretStore is cluster-scoped. Any ExternalSecret in any namespace
# can reference this store. For namespace-scoped isolation, use SecretStore
# instead (one per namespace, each with its own workload identity).
#
# WHEN TO USE ClusterSecretStore:
#   - Shared infrastructure secrets (TLS certs, shared API keys)
#   - Small clusters where namespace isolation is not required
#   - Lab and demo environments
#
# WHEN TO USE SecretStore (namespace-scoped):
#   - Multi-tenant clusters where teams must not access each other's secrets
#   - Regulated environments requiring per-team audit trails
#   - Least-privilege: each namespace gets its own managed identity
#
# AUTHENTICATION FLOW (Workload Identity):
# 1. ESO pod runs with a Kubernetes ServiceAccount annotated with the
#    Azure managed identity client ID.
# 2. The AKS OIDC issuer provides a federated token to the pod.
# 3. ESO exchanges the federated token for an Azure AD access token
#    via the Azure Identity SDK (no client secret needed).
# 4. ESO uses the access token to read secrets from Key Vault.
#
# PREREQUISITES:
# 1. AKS cluster with OIDC issuer and workload identity enabled:
#      az aks update -g <rg> -n <cluster> --enable-oidc-issuer --enable-workload-identity
# 2. Azure managed identity created:
#      az identity create -g <rg> -n <identity-name>
# 3. Key Vault role assignment (least privilege):
#      az role assignment create \
#        --assignee <identity-client-id> \
#        --role "Key Vault Secrets User" \
#        --scope /subscriptions/<sub>/resourceGroups/<rg>/providers/Microsoft.KeyVault/vaults/<vault>
# 4. Federated identity credential linking K8s SA to managed identity:
#      az identity federated-credential create \
#        --name eso-federation \
#        --identity-name <identity-name> \
#        --resource-group <rg> \
#        --issuer <aks-oidc-issuer-url> \
#        --subject system:serviceaccount:external-secrets:external-secrets \
#        --audiences api://AzureADTokenExchange
#
# SECURITY NOTES:
# - The "Key Vault Secrets User" role grants read-only access to secrets.
#   ESO never needs write access to the vault.
# - Workload identity eliminates long-lived client secrets entirely.
#   The federated token is short-lived and scoped to the specific pod.
# - Key Vault access logs (Azure Monitor) provide a full audit trail
#   of which secrets were accessed and when.
#
# REGULATORY CONTEXT:
#   - SOC 2 CC6.1: Identity-based access via workload identity
#   - SOC 2 CC6.7: Centralized secrets management in Key Vault
#   - DORA Article 9: Access control via Azure RBAC, not shared credentials
#   - PCI-DSS Req 8: Unique identity per workload (managed identity)
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: azure-keyvault
  labels:
    app.kubernetes.io/part-of: external-secrets
    # Regulatory compliance annotations for auditor traceability
    compliance.regulated/ncua: "credential-management"
    compliance.regulated/soc2: "CC6.1-CC6.7"
    compliance.regulated/dora: "article-9"
    compliance.regulated/pci-dss: "req-3.4-req-8"
spec:
  # ---------------------------------------------------------------------------
  # PROVIDER CONFIGURATION
  # ---------------------------------------------------------------------------
  # Tells ESO which external secret backend to use and how to authenticate.
  # Azure Key Vault is the native choice for AKS clusters.
  #
  # SUPPORTED AZURE AUTH METHODS:
  #   1. Workload Identity (recommended) -- federated OIDC, no client secret
  #   2. Service Principal -- requires client ID + client secret in a K8s Secret
  #   3. Managed Identity -- for VM-based clusters (not AKS workload identity)
  # ---------------------------------------------------------------------------
  provider:
    azurekv:
      # -----------------------------------------------------------------------
      # AUTH TYPE
      # -----------------------------------------------------------------------
      # "WorkloadIdentity" uses the AKS OIDC issuer to exchange a Kubernetes
      # service account token for an Azure AD access token. This is the most
      # secure option because no long-lived credentials exist anywhere.
      # -----------------------------------------------------------------------
      authType: WorkloadIdentity

      # -----------------------------------------------------------------------
      # KEY VAULT URL
      # -----------------------------------------------------------------------
      # The DNS name of your Azure Key Vault. Replace with your actual vault.
      #
      # NAMING CONVENTION:
      # Key Vault names are globally unique across Azure. Use a prefix that
      # identifies your org/team/environment:
      #   kv-<org>-<env>-<purpose>
      #   e.g., kv-myorg-prod-platform, kv-acme-staging-app
      # -----------------------------------------------------------------------
      vaultUrl: "https://kv-regulated-demo.vault.azure.net"

      # -----------------------------------------------------------------------
      # SERVICE ACCOUNT REFERENCE
      # -----------------------------------------------------------------------
      # The Kubernetes ServiceAccount that ESO uses to obtain the federated
      # OIDC token. This SA must:
      # 1. Exist in the specified namespace
      # 2. Have the annotation:
      #      azure.workload.identity/client-id: <managed-identity-client-id>
      # 3. Be linked via a federated identity credential in Azure AD
      #
      # The ESO Helm chart creates this ServiceAccount automatically.
      # You only need to add the workload identity annotation.
      # -----------------------------------------------------------------------
      serviceAccountRef:
        name: external-secrets
        namespace: external-secrets
