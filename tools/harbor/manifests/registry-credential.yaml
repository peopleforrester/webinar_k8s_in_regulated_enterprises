# ABOUTME: Kubernetes Secret and configuration for pulling images from Harbor on AKS.
# ABOUTME: Demonstrates robot account credentials, imagePullSecret usage, and namespace setup.

# =============================================================================
# HARBOR REGISTRY CREDENTIALS
# =============================================================================
# This manifest creates the credentials and configuration needed for AKS
# workloads to pull container images from a private Harbor registry.
#
# AUTHENTICATION FLOW:
# 1. Harbor robot account is created (via UI or API) with pull-only scope
# 2. Credentials are stored as a Kubernetes dockerconfigjson Secret
# 3. Pods reference the Secret via imagePullSecrets
# 4. Kubelet presents the credentials when pulling images from Harbor
#
# ROBOT ACCOUNTS VS USER ACCOUNTS:
# Robot accounts are the recommended authentication method for CI/CD and
# workloads because they:
#   - Have scoped permissions (per-project, per-action)
#   - Can be revoked without affecting human users
#   - Do not expire based on user password policies
#   - Have their own audit trail separate from human activity
#   - Support configurable expiration (or no expiration)
#
# CREATING A ROBOT ACCOUNT (via Harbor API):
#   curl -u admin:Harbor12345 \
#     -H "Content-Type: application/json" \
#     -X POST https://harbor.example.com/api/v2.0/robots \
#     -d '{
#       "name": "aks-pull",
#       "description": "AKS cluster image pull credentials",
#       "duration": -1,
#       "level": "project",
#       "permissions": [{
#         "namespace": "regulated-apps",
#         "kind": "project",
#         "access": [
#           {"resource": "repository", "action": "pull"},
#           {"resource": "repository", "action": "list"}
#         ]
#       }]
#     }'
#
# The response includes the robot account name (robot$aks-pull) and secret.
# Store these in Azure Key Vault and sync with External Secrets Operator.
#
# CREATING A ROBOT ACCOUNT (via Harbor UI):
# 1. Log in to Harbor > Project > regulated-apps > Robot Accounts
# 2. Click "+ New Robot Account"
# 3. Name: aks-pull
# 4. Expiration: Set based on rotation policy (or "Never")
# 5. Permissions: Pull and List on Repository
# 6. Copy the generated secret immediately (shown only once)
#
# REGULATORY CONTEXT:
#   - NCUA Part 748: Service accounts with least-privilege access
#   - SOC 2 CC6.1: Unique identity per automated system
#   - SOC 2 CC6.3: Credential lifecycle management (rotation, revocation)
#   - DORA Article 9: Access control for ICT systems
#   - PCI-DSS Req 8.6: Unique IDs for automated/service accounts
# =============================================================================

---
# -----------------------------------------------------------------------------
# SECRET: HARBOR IMAGE PULL CREDENTIALS
# -----------------------------------------------------------------------------
# Docker registry credentials stored as a Kubernetes Secret.
# Kubelet uses this to authenticate when pulling images from Harbor.
#
# SECRET TYPE: kubernetes.io/dockerconfigjson
# This special type tells Kubernetes the Secret contains Docker
# registry authentication data in the standard .dockerconfigjson format.
#
# CREATING THIS SECRET (RECOMMENDED METHOD):
# Use kubectl to generate the Secret from credentials:
#
#   kubectl create secret docker-registry harbor-pull-secret \
#     --docker-server=harbor.example.com \
#     --docker-username=robot$regulated-apps+aks-pull \
#     --docker-password=<robot-account-secret> \
#     --docker-email=platform-team@example.com \
#     -n demo
#
# CREATING VIA EXTERNAL SECRETS OPERATOR (PRODUCTION):
# Store the dockerconfigjson in Azure Key Vault and use an ExternalSecret
# to sync it into the cluster. See tools/external-secrets/ for examples.
#
# CREDENTIAL ROTATION:
# 1. Create a new robot account in Harbor
# 2. Update the Secret (or let ESO sync the new value)
# 3. Existing pods continue using cached credentials until restart
# 4. New pods pick up the updated Secret automatically
# 5. Delete the old robot account after all pods have rotated
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: harbor-pull-secret
  namespace: demo
  labels:
    app.kubernetes.io/part-of: harbor
    app.kubernetes.io/component: registry-credential
    compliance.regulated/ncua: "access-control"
    compliance.regulated/soc2: "CC6.1-CC6.3"
  annotations:
    # -------------------------------------------------------------------------
    # CREDENTIAL METADATA
    # -------------------------------------------------------------------------
    # These annotations help operators track credential lifecycle.
    # Update these when rotating the robot account credentials.
    # -------------------------------------------------------------------------
    harbor.goharbor.io/robot-account: "robot$regulated-apps+aks-pull"
    harbor.goharbor.io/project: "regulated-apps"
    harbor.goharbor.io/permissions: "pull,list"
type: kubernetes.io/dockerconfigjson
data:
  # ---------------------------------------------------------------------------
  # DOCKER CONFIG JSON
  # ---------------------------------------------------------------------------
  # Base64-encoded Docker configuration containing registry credentials.
  #
  # THE DECODED JSON STRUCTURE:
  # {
  #   "auths": {
  #     "harbor.example.com": {
  #       "username": "robot$regulated-apps+aks-pull",
  #       "password": "<robot-account-secret>",
  #       "auth": "<base64(username:password)>"
  #     }
  #   }
  # }
  #
  # PLACEHOLDER VALUE BELOW:
  # The base64 value below decodes to a placeholder. Replace with actual
  # credentials generated from your Harbor robot account.
  #
  # To generate the correct base64 value:
  #   echo '{"auths":{"harbor.example.com":{"username":"robot$regulated-apps+aks-pull","password":"REPLACE-WITH-ROBOT-SECRET","auth":"REPLACE-WITH-BASE64-USER-PASS"}}}' | base64 -w 0
  # ---------------------------------------------------------------------------
  # PLACEHOLDER — generate real credentials with:
  #   kubectl create secret docker-registry harbor-pull-secret \
  #     --docker-server=harbor.example.com \
  #     --docker-username=robot$regulated-apps+aks-pull \
  #     --docker-password=<robot-account-secret> \
  #     -n regulated-apps
  .dockerconfigjson: REPLACE_WITH_BASE64_ENCODED_DOCKER_CONFIG

---
# -----------------------------------------------------------------------------
# SECRET: HARBOR CI/CD PUSH CREDENTIALS
# -----------------------------------------------------------------------------
# Separate credentials for CI/CD pipelines that push images to Harbor.
# Push credentials have broader permissions than pull-only credentials.
#
# SEPARATION OF PUSH AND PULL:
# Using different robot accounts for push (CI/CD) and pull (workloads)
# follows the principle of least privilege:
#   - Pull accounts: Can only download images (used by kubelet)
#   - Push accounts: Can upload and tag images (used by CI/CD)
#
# If a pull credential is compromised, the attacker cannot push
# malicious images. If a push credential is compromised, it can be
# revoked without affecting running workloads.
#
# REGULATORY CONTEXT (SOC 2 CC6.1):
# "Logical access security" -- separate credentials for separate functions
# with minimum necessary permissions.
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: harbor-push-secret
  namespace: ci-cd
  labels:
    app.kubernetes.io/part-of: harbor
    app.kubernetes.io/component: registry-credential
    compliance.regulated/ncua: "access-control"
    compliance.regulated/soc2: "CC6.1"
  annotations:
    harbor.goharbor.io/robot-account: "robot$regulated-apps+ci-push"
    harbor.goharbor.io/project: "regulated-apps"
    harbor.goharbor.io/permissions: "push,pull,list,tag"
type: kubernetes.io/dockerconfigjson
data:
  # ---------------------------------------------------------------------------
  # PLACEHOLDER: Replace with actual CI/CD robot account credentials.
  # Create via Harbor UI or API with push+pull+list+tag permissions.
  #
  # kubectl create secret docker-registry harbor-push-secret \
  #   --docker-server=harbor.example.com \
  #   --docker-username=robot$regulated-apps+ci-push \
  #   --docker-password=<robot-account-secret> \
  #   --docker-email=ci-cd@example.com \
  #   -n ci-cd
  # ---------------------------------------------------------------------------
  # PLACEHOLDER — generate real credentials with:
  #   kubectl create secret docker-registry harbor-push-secret \
  #     --docker-server=harbor.example.com \
  #     --docker-username=robot$regulated-apps+ci-push \
  #     --docker-password=<robot-account-secret> \
  #     -n ci-cd
  .dockerconfigjson: REPLACE_WITH_BASE64_ENCODED_DOCKER_CONFIG

---
# -----------------------------------------------------------------------------
# EXAMPLE: POD USING HARBOR IMAGE PULL SECRET
# -----------------------------------------------------------------------------
# Shows how a workload references the Harbor pull secret to authenticate
# when pulling images from the private registry.
#
# THREE METHODS TO ATTACH IMAGE PULL SECRETS:
#
# 1. PER-POD (shown below):
#    Add imagePullSecrets to each pod spec. Most explicit and auditable.
#
# 2. PER-SERVICE-ACCOUNT:
#    Patch the default ServiceAccount to include the secret:
#      kubectl patch serviceaccount default -n demo \
#        -p '{"imagePullSecrets": [{"name": "harbor-pull-secret"}]}'
#    All pods using "default" SA in the namespace auto-inherit the secret.
#
# 3. PER-NAMESPACE (via Kyverno policy):
#    Use a Kyverno mutating policy to inject imagePullSecrets into every
#    pod in specific namespaces. See tools/kyverno/ for examples.
#    This is the recommended approach for regulated environments because
#    it ensures consistent credential attachment without developer effort.
#
# REGULATORY CONTEXT (NCUA/FFIEC):
# "Consistent application of security controls" -- method 3 (Kyverno)
# ensures no pod accidentally pulls from an unauthenticated source.
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: harbor-pull-example
  namespace: demo
  labels:
    app.kubernetes.io/name: harbor-pull-example
    app.kubernetes.io/part-of: harbor
spec:
  # ---------------------------------------------------------------------------
  # IMAGE PULL SECRETS
  # ---------------------------------------------------------------------------
  # References the dockerconfigjson Secret created above.
  # Kubelet uses these credentials when pulling the container image.
  #
  # MULTIPLE SECRETS:
  # You can list multiple secrets if pulling from multiple registries:
  #   imagePullSecrets:
  #     - name: harbor-pull-secret
  #     - name: acr-pull-secret
  #     - name: dockerhub-secret
  # ---------------------------------------------------------------------------
  imagePullSecrets:
    - name: harbor-pull-secret

  containers:
    - name: app
      # -----------------------------------------------------------------------
      # IMAGE REFERENCE
      # -----------------------------------------------------------------------
      # Full Harbor image reference format:
      #   <harbor-host>/<project>/<repository>:<tag>
      #
      # EXAMPLES:
      #   harbor.example.com/regulated-apps/nginx:1.25
      #   harbor.example.com/regulated-apps/my-api:v2.1.0
      #   harbor.example.com/dev-images/debug-tools:latest
      #
      # ALWAYS USE SPECIFIC TAGS (not :latest) in regulated environments.
      # Tag immutability can be enforced per-project in Harbor settings.
      # -----------------------------------------------------------------------
      image: harbor.example.com/regulated-apps/nginx:1.25
      ports:
        - containerPort: 8080
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
